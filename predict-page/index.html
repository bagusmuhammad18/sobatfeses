<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, minimum-scale=1.0" />
    <title>SobatFeses</title>
    <link rel="icon" href="../assets/pavicon2.png" />
    <!-- Style -->
    <link rel="stylesheet" href="../styles/upload.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;900&family=Poppins:wght@200;300;400;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/feather-icons"></script>
  </head>

  <body>
    <nav class="navbar">
      <i data-feather="menu" id="hamburger-menu"></i>
      <a class="logo" href="/index.html">
        <img class="nav-logo" src="/assets/nav-logo.png" alt="" />&nbsp;&nbsp;
        Sobat
        <div class="yellow">Feses</div>
      </a>
      <div class="navbar-nav">
        <div class="navMenu">
          <div class="navMenu-cont">
            <a href="/index.html">Beranda</a>
            <a href="/index.html#tentang-kami">Tentang Kami</a>
            <a href="/index.html#kontak">Kontak</a>
            <a href="/faq/index.html">FAQ</a>
          </div>
          <div class="cobaSekarang-cont">
            <a class="cobaSekarang" href="/predict-page/index.html"
              >Coba Sekarang</a
            >
          </div>
        </div>
      </div>
    </nav>

    <main>
      <h1>Unggah foto feses Anda di sini</h1>
      <h4>
        Pastikan foto tersebut memiliki pencahayaan yang baik<br />Anda dapat
        menggunakan fitur senter bila diperlukan
      </h4>

      <div id="imagePreviewContainer">
        <h3 class="clickTo">Klik untuk Menghilangkan Efek Blur</h3>
        <div class="webcam">
          <label for="webcamUpload" class="webcam-custom"
            >Nyalakan Kamera</label
          >
          <input
            id="webcamUpload"
            type="file"
            accept="image/*"
            capture="camera"
          />
        </div>
        <p id="or">atau</p>

        <div class="file">
          <label for="fileUpload" class="file-custom">Ambil dari Galeri</label>
          <input id="fileUpload" type="file" accept="image/*" />
        </div>

        <img id="imagePreview" hidden />
      </div>
      <div class="buttonUnder">
        <button id="reuploadButton">Unggah Ulang</button>
        <button id="generateButton">Cek Hasil</button>
      </div>

      <div id="label-container"></div>
      <div id="result"></div>
    </main>
    <footer>
      <div class="containerKiri">
        <a href="../faq/index.html">FAQ</a>
        <a href="../index.html#tentang-kami">Tentang Kami</a>
      </div>
      <div class="containerKanan">
        <p class="bold">NPC ELB</p>
        <p>npcelb@gmail.com</p>
        <!-- <p class="bold">Fakultas Matematika dan Ilmu Pengetahuan Alam</p>
        <p class="bold">Universitas Gadjah Mada</p>
        <p>Sekip Utara Bulaksumur Yogyakarta 55281</p> -->
      </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
    <script type="text/javascript">
      if (window.innerWidth <= 1024) {
        document.getElementsByClassName("webcam-custom")[0].style.display =
          "inline-block";
        document.getElementById("or").style.display = "inline-block";
      } else {
        document.getElementById("or").style.display = "none";
      }

      const URL = "./model/";
      let model, labelContainer, maxPredictions;
      let fileUploadInput; // Added variable for file input

      // Starting the model immediately after page loads
      window.addEventListener("load", init);
      async function init() {
        document
          .getElementById("reuploadButton")
          .addEventListener("click", () => {
            resetWebState();
            const imagePreview = document.getElementById("imagePreview");
            imagePreview.classList.remove("unblur");
          });
        // Initialize fileUploadInput variable
        fileUploadInput = document.getElementById("fileUpload");

        const modelURL = URL + "model.json";
        const metadataURL = URL + "metadata.json";

        model = await tmImage.load(modelURL, metadataURL);
        maxPredictions = model.getTotalClasses();

        document
          .getElementById("webcamUpload")
          .addEventListener("change", async (event) => {
            const image = await loadImage(event.target.files[0]);
            document.getElementById("imagePreview").src = image.src;
            document.getElementById("reuploadButton").style.visibility =
              "visible";
            document.getElementById("generateButton").style.visibility =
              "visible";
            document.getElementById("imagePreview").hidden = false;
            document.querySelector(".webcam").style.display = "none";
            document.getElementById("or").style.display = "none";
            document.querySelector(".file").style.display = "none";
          });

        fileUploadInput.addEventListener("change", async (event) => {
          const image = await loadImage(event.target.files[0]);
          document.getElementById("imagePreview").src = image.src;
          document.getElementById("reuploadButton").style.visibility =
            "visible";
          document.getElementById("generateButton").style.visibility =
            "visible";
          document.getElementById("imagePreview").hidden = false;
          document.querySelector(".webcam").style.display = "none";
          document.getElementById("or").style.display = "none";
          document.querySelector(".file").style.display = "none";
        });

        function resetWebState() {
          document.getElementById("imagePreview").src = "";
          document.getElementById("reuploadButton").style.visibility = "hidden";
          document.getElementById("generateButton").style.visibility = "hidden";
          document.getElementById("imagePreview").hidden = true;
          document.querySelector(".webcam").style.display = "block";
          document.querySelector(".file").style.display = "block";
          if (window.innerWidth <= 1024) {
            document.getElementsByClassName("webcam-custom")[0].style.display =
              "inline-block";
            document.getElementById("or").style.display = "inline-block";
          } else {
            document.getElementById("or").style.display = "none";
          }

          clearFileInput(fileUploadInput); // Clear file input value
        }

        document
          .getElementById("reuploadButton")
          .addEventListener("click", resetWebState);

        labelContainer = document.getElementById("label-container");
        for (let i = 0; i < maxPredictions; i++) {
          labelContainer.appendChild(document.createElement("div"));
        }

        document
          .getElementById("generateButton")
          .addEventListener("click", () => {
            const image = document.getElementById("imagePreview");
            predict(image);
          });

        function toggleBlur() {
          const imagePreview = document.getElementById("imagePreview");
          imagePreview.classList.toggle("unblur");
          document.querySelector(".clickTo").classList.toggle("clickToIlang");
        }

        document
          .getElementById("imagePreview")
          .addEventListener("click", toggleBlur);
      }

      async function loadImage(file) {
        return new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = (event) => {
            const image = new Image();
            image.onload = () => resolve(image);
            image.src = event.target.result;
          };
          reader.readAsDataURL(file);
        });
      }

      async function predict(image) {
        const prediction = await model.predict(image);

        let bestPredictionIndex = 0;
        let bestPredictionValue = prediction[0].probability;

        for (let i = 1; i < maxPredictions; i++) {
          if (prediction[i].probability > bestPredictionValue) {
            bestPredictionIndex = i;
            bestPredictionValue = prediction[i].probability;
          }
        }

        for (let i = 0; i < maxPredictions; i++) {
          const classPrediction =
            prediction[i].className +
            ": " +
            prediction[i].probability.toFixed(2);

          // let classPredictionElement = document.createElement("div");
          // classPredictionElement.innerHTML = classPrediction;

          // if (i === bestPredictionIndex) {
          //   classPredictionElement.style.fontWeight = "bold";
          // }

          // labelContainer.childNodes[i].innerHTML = "";
          // labelContainer.childNodes[i].appendChild(classPredictionElement);

          // let progressBarElement = document.createElement("div");
          // progressBarElement.className = "progress-bar";
          // labelContainer.childNodes[i].appendChild(progressBarElement);
        }

        // const bestPrediction = bestPredictionIndex;
        // document.getElementById("result").innerHTML =
        //   "Masuk ke class: " + bestPrediction;
        if (bestPredictionIndex === 0) {
          window.location.href = "sembelit.html";
          // alert("sembelit");
        } else if (bestPredictionIndex === 1) {
          window.location.href = "normal.html";
          // alert("normal");
        } else if (bestPredictionIndex === 2) {
          window.location.href = "diare.html";
          // alert("diare");
        }
      }

      function clearFileInput(fileInput) {
        try {
          fileInput.value = ""; // For most browsers
          if (fileInput.value) {
            // For IE11, Opera, Safari, etc.
            fileInput.type = "text";
            fileInput.type = "file";
          }
        } catch (error) {
          console.log(error);
        }
      }
      if (innerWidth > 1024) {
        document.getElementsByClassName("file-custom")[0].style.color = "white";
        document.getElementsByClassName(
          "file-custom"
        )[0].style.backgroundColor = "#3f497f";
      }
      document
        .getElementById("imagePreview")
        .addEventListener("click", unblurImage);
    </script>

    <script>
      feather.replace();
    </script>
    <script src="../js/upload.js" type="text/javascript"></script>
  </body>
</html>
